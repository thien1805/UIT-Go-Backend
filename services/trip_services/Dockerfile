# ==========================================
# Dockerfile cho Trip Service - UIT-Go Backend
# ==========================================

# Sá»­ dá»¥ng Python 3.11 official image lÃ m base image
FROM python:3.11-slim

# Metadata
LABEL maintainer="UIT-Go Team"
LABEL service="trip-service"
LABEL version="1.0"

# Set environment variables
# NgÄƒn Python táº¡o .pyc files (bytecode)
ENV PYTHONDONTWRITEBYTECODE=1
# NgÄƒn Python buffer output (logs xuáº¥t hiá»‡n real-time)
ENV PYTHONUNBUFFERED=1

# Táº¡o thÆ° má»¥c lÃ m viá»‡c trong container
WORKDIR /app

# CÃ i Ä‘áº·t system dependencies cáº§n thiáº¿t
# postgresql-client: Ä‘á»ƒ káº¿t ná»‘i vá»›i PostgreSQL
# gcc, python3-dev, musl-dev: Ä‘á»ƒ build má»™t sá»‘ Python packages
RUN apt-get update && apt-get install -y \
    postgresql-client \
    gcc \
    python3-dev \
    libpq-dev \
    && rm -rf /var/lib/apt/lists/*

# Copy requirements.txt trÆ°á»›c Ä‘á»ƒ táº­n dá»¥ng Docker cache
# Náº¿u requirements.txt khÃ´ng thay Ä‘á»•i, Docker sáº½ cache layer nÃ y
COPY requirements.txt .

# Upgrade pip vÃ  cÃ i Ä‘áº·t dependencies
RUN pip install --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy toÃ n bá»™ source code vÃ o container
COPY . .

# Táº¡o thÆ° má»¥c cho static files vÃ  media files
RUN mkdir -p /app/staticfiles /app/mediafiles

# Expose port 8002 (Trip Service)
EXPOSE 8002

# Script Ä‘á»ƒ cháº¡y migrations vÃ  start server
# Táº¡o script entrypoint
RUN echo '#!/bin/bash\n\
set -e\n\
\n\
echo "â³ Äá»£i database sáºµn sÃ ng..."\n\
while ! pg_isready -h $DB_HOST -p $DB_PORT -U $DB_USER; do\n\
  echo "Database chÆ°a sáºµn sÃ ng, Ä‘á»£i 2 giÃ¢y..."\n\
  sleep 2\n\
done\n\
\n\
echo "âœ… Database Ä‘Ã£ sáºµn sÃ ng!"\n\
\n\
echo "ðŸ”„ Cháº¡y migrations..."\n\
python manage.py migrate --noinput\n\
\n\
echo "ðŸ“¦ Thu tháº­p static files..."\n\
python manage.py collectstatic --noinput --clear || true\n\
\n\
echo "ðŸš€ Khá»Ÿi Ä‘á»™ng Trip Service trÃªn port 8002..."\n\
python manage.py runserver 0.0.0.0:8002\n\
' > /app/entrypoint.sh && chmod +x /app/entrypoint.sh

# Set entrypoint
ENTRYPOINT ["/app/entrypoint.sh"]

